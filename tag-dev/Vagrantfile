# -*- mode: ruby -*-
# vi: set ft=ruby :

$box_name = "tag-dev"

$set_timezone = <<SCRIPT
/bin/rm -f /etc/localtime
echo America/Los_Angeles > /etc/timezone
dpkg-reconfigure --frontend noninteractive tzdata
SCRIPT

$emacs25_script = <<EMACS25_SCRIPT
export DEBIAN_FRONTEND=noninteractive

echo "enabling kelleyk/emacs repository"
add-apt-repository -y ppa:kelleyk/emacs
apt-get update

echo "installing emacs25"
apt-get -y install emacs25
for alt in ctags25 ebrowse25 emacs25 emacsclient25 etags25
do
    base=$(echo $alt | perl -pe 's/25$//')
    update-alternatives --set $base /usr/bin/$alt
done
EMACS25_SCRIPT

$setup_tag_dots = <<SCRIPT
export TAG_ROOT=/home/vagrant/home/tag

FILES=".bash_aliases .bash_functions .bash_login .bash_logout .bashrc .emacs.d \
.environment_bash .gdbinit .gitconfig .gitignore .mspdebug"

if [ -e /home/vagrant/repos ] ; then
    export TAG_ROOT=/home/vagrant/repos/tag
fi

ln -s $TAG_ROOT /home/vagrant/tag

if [ ! -e $TAG_ROOT ] ; then
    mkdir $TAG_ROOT
    cd $TAG_ROOT
    echo cloning dot-files
    git clone -o mm  -q https://github.com/MamMark/dot-files.git
    echo cloning prod
    git clone -o ffa -q https://github.com/tp-freeforall/prod
    echo cloning MamMark
    git clone -o mm  -q https://github.com/MamMark/mm.git
    cd ~

    # generate custom places for MM_ROOT and TINYOS_ROOT
    cat > ~/.environment_bash.local <<EOF

# auto generated by Vagrantfile

export TOSMAKE_NO_COLOR=1
export MM_ROOT=/home/vagrant/home/tag/mm
export TINYOS_ROOT_DIR=/home/vagrant/home/tag/prod
export TINYOS_ROOT_DIR_ADDITIONAL="\\\$MM_ROOT:\\\$TINYOS_ROOT_DIR_ADDITIONAL"
EOF
fi

if [ -e $TAG_ROOT/dot-files ] ; then
    SRC_DIR=$TAG_ROOT/dot-files/
    DST_DIR=~/
    echo -e "\n*** dots from $SRC_DIR -> $DST_DIR ***"
    (for i in $FILES; do echo $i; done) | rsync -aiuWr --files-from=- $SRC_DIR $DST_DIR
fi

if [ -e .profile ] ; then /bin/rm .profile; fi
if [ ! -e ~/.Xresources ] ; then touch ~/.Xresources; fi
if [ ! -e ~/.Xauthority ] ; then touch ~/.Xauthority; fi

#  cd $TINYOS_ROOT_DIR/apps/Blink
#  make debugopt exp_msp432
SCRIPT

Vagrant.configure(2) do |config|
  config.vm.box = "ubuntu_dev/arm_msp"
  config.vm.box_url = 'http://www.tinyprod.net/boxes/ubuntu_dev-arm_msp.json'
  config.vm.box_check_update = true
  config.vbguest.auto_update = false

  config.vm.define $box_name
  config.vm.hostname = $box_name

  config.ssh.forward_x11 = true
  config.ssh.forward_agent = true
  config.ssh.insert_key = true
  config.vm.provision :shell, inline: $set_timezone
  config.vm.provision :shell, inline: $emacs25_script
  config.vm.provision :shell, privileged: false, path: "../common/emacs_init.el"
  config.vm.provision :shell, privileged: false, inline: $setup_tag_dots

  config.vm.synced_folder "~/", "/home/vagrant/home"
#  config.vm.synced_folder "/Volumes/Repos", "/home/vagrant/repos"

  config.vm.network "public_network", bridge: ""

  config.vm.provider "virtualbox" do |vb|
    vb.name = $box_name
  end
end
