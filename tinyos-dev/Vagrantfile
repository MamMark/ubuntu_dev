# -*- mode: ruby -*-
# vi: set ft=ruby :

$box_name = "arm-dev-64"

$modify_bashrc = <<SCRIPT

cd ~
if [ ! -e ~/.bashrc_env ] ; then
cat >> ~/.bashrc <<EOF
. ~/.bashrc_env
EOF

cat > ~/.bashrc_env <<EOF
if [ -z \\\$TINYOS_ENV_SET ] ; then
	export NEW_HOME=/home/vagrant
	export DEV_ROOT=\\\$NEW_HOME/msp432dev
	export MM_ROOT=\\\$DEV_ROOT/mm
	export TINYOS_ROOT_DIR=\\\$DEV_ROOT/prod
	export TINYOS_ROOT_DIR_ADDITIONAL=\\\$MM_ROOT:\\\$TINYOS_ROOT_DIR_ADDITIONAL
	export CLASSPATH=.:\\\$TINYOS_ROOT_DIR/support/sdk/java/tinyos.jar
	export PYTHONPATH=\\\$TINYOS_ROOT_DIR/support/sdk/python:\\\$PYTHONPATH
	export PYTHONPATH=/usr/local/lib/python3.4/dist-packages:\\\$PYTHONPATH
	export TINYOS_ENV_SET="true"
fi
EOF
fi

. ~/.bashrc_env
if [ ! -e $DEV_ROOT ] ; then
    mkdir $DEV_ROOT
    cd $DEV_ROOT
    git clone -v git://github.com/tp-freeforall/prod
    git clone -v git://github.com/MamMark/mm.git
    cd ~
fi

#cd $TINYOS_ROOT_DIR/apps/Blink
#make debugopt telosb
#make debugopt exp5438_gps
SCRIPT

Vagrant.configure(2) do |config|
  config.vm.box = "ubuntu_dev/arm_msp"
  config.vm.box_url = 'ubuntu_dev-arm_msp.json'
#  config.vm.box_url = 'http://www.tinyprod.net/boxes/ubuntu_dev-arm_msp.json'
  config.vm.box_check_update = true

  config.vm.define $box_name
  config.vm.hostname = $box_name

  config.ssh.forward_x11 = true
  config.ssh.forward_agent = true

  config.vm.synced_folder "~/", "/home/vagrant/home"

  config.vm.network "public_network", bridge: ""

  # Set the timezone to the host timezone
  require 'time'
  timezone = 'Etc/GMT' + ((Time.zone_offset(Time.now.zone)/60)/60).to_s
  config.vm.provision :shell, :inline => "if [ $(grep -c UTC /etc/timezone) -gt 0 ]; then echo \"#{timezone}\" | sudo tee /etc/timezone && dpkg-reconfigure --frontend noninteractive tzdata; fi"

  #timezone = File.read("/etc/timezone")

  config.vm.provider "virtualbox" do |vb, override|
    vb.name = $box_name
    override.vm.provision :shell, privileged: false, inline: $modify_bashrc
  end
end
